<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seller Dashboard - KantekGO</title>
  <style>
    body{font-family:Inter,Arial,sans-serif;margin:0;background:#fbf6f0;color:#111}
    .wrap{max-width:1000px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between}
    .card{background:#fff;padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.06);margin-bottom:14px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #eee}
    .btn{padding:6px 10px;background:#f2994a;color:#fff;border-radius:8px;border:none;cursor:pointer}
    .select{padding:6px;border-radius:6px}
    .cash{font-size:1.2rem;font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;gap:10px;align-items:center"><span style="width:36px;height:36px;border-radius:50%;background:#7fb36b;display:inline-block"></span><strong>Seller Dashboard</strong></div>
      <div><a href="index.html">Beranda</a> <a href="login.html" style="margin-left:8px">Login</a></div>
    </header>

    <div class="card">
      <h3>Filter Gerai</h3>
      <select id="geraiFilter" class="select">
        <option value="all">Semua</option>
        <option value="1">Gerai 1</option>
        <option value="2">Gerai 2</option>
        <option value="3">Gerai 3</option>
      </select>
    </div>

    <div class="card">
      <h3>Antrian Pesanan</h3>
      <div id="ordersWrap"></div>
    </div>

    <div class="card">
      <h3>Dashboard Cashflow</h3>
      <p>Total penjualan (selesai): <span class="cash" id="totalCash">Rp 0</span></p>
    </div>

    <footer style="margin-top:18px">Kantin Teknik Universitas Indonesia</footer>
  </div>

  <script>
    function format(n){ return 'Rp ' + n.toLocaleString(); }
    function loadOrders(){
      const all = JSON.parse(localStorage.getItem('kantek_orders')||'[]');
      const gerai = document.getElementById('geraiFilter').value;
      return all.filter(o => gerai==='all' ? true : o.gerai===gerai);
    }
    function renderOrders(){
      const wrap = document.getElementById('ordersWrap');
      const orders = loadOrders();
      if(orders.length===0){ wrap.innerHTML = '<p>Tidak ada pesanan.</p>'; return; }
      let html = '<table><tr><th>ID</th><th>Gerai</th><th>Pembeli</th><th>Items</th><th>Status</th><th>Aksi</th></tr>';
      orders.forEach(o=>{
        const items = o.items.map(it=>it.name + ' x' + it.qty).join(', ');
        html += `<tr><td>${o.id}</td><td>${o.gerai}</td><td>${o.buyer.name}</td><td>${items}</td><td id="st_${o.id}">${o.status}</td><td>
          <select id="sel_${o.id}" class="select">
            <option value="menunggu antrian">menunggu antrian</option>
            <option value="sedang diproses">sedang diproses</option>
            <option value="selesai">selesai</option>
          </select>
          <button class="btn" data-id="${o.id}">Update</button>
        </td></tr>`;
      });
      html += '</table>';
      wrap.innerHTML = html;
      // set selects to current
      orders.forEach(o=>{
        const sel = document.getElementById('sel_'+o.id);
        if(sel) sel.value = o.status;
      });
      // attach update handlers
      wrap.querySelectorAll('.btn').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = b.dataset.id;
          const sel = document.getElementById('sel_'+id);
          updateStatus(id, sel.value);
        });
      });
    }

    function updateStatus(orderId, newStatus){
      const orders = JSON.parse(localStorage.getItem('kantek_orders')||'[]');
      const idx = orders.findIndex(o=>o.id===orderId);
      if(idx===-1) return alert('Order not found');
      orders[idx].status = newStatus;
      localStorage.setItem('kantek_orders', JSON.stringify(orders));
      // show UI change
      const st = document.getElementById('st_'+orderId);
      if(st) st.textContent = newStatus;
      // if selesai â€” send notification to buyer (if possible) and update cashflow
      if(newStatus==='selesai'){
        try{
          const buyerName = orders[idx].buyer.name;
          // store last-notif to simulate push
          const notKey = 'kantek_last_notif_' + orders[idx].buyer.id;
          localStorage.setItem(notKey, JSON.stringify({orderId, message:'Pesanan Anda sudah selesai.'}));
          alert('Status diubah menjadi selesai. Buyer ('+buyerName+') akan menerima notifikasi saat membuka situs.');
        }catch(e){}
      }
      renderCash();
    }

    function renderCash(){
      const orders = JSON.parse(localStorage.getItem('kantek_orders')||'[]');
      const done = orders.filter(o => o.status === 'selesai');
      const total = done.reduce((s,o)=> s + o.items.reduce((ss,it)=> ss + it.price * it.qty, 0), 0);
      document.getElementById('totalCash').textContent = format(total);
    }

    document.getElementById('geraiFilter').addEventListener('change', renderOrders);
    renderOrders();
    renderCash();

    // poll to reflect external changes quickly (since this is all in localStorage)
    setInterval(()=>{ renderOrders(); renderCash(); }, 2000);
  </script>
</body>
</html>
