<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Status Pesanan</title>
<style>
  body{font-family:Helvetica, Arial, sans-serif;margin:0;background:#fbf6f0;color:#111}
  .wrap{max-width:900px;margin:36px auto;padding:20px}
  header{display:flex;align-items:center;gap:10px}
  h1{font-size:1.9rem;margin:12px 0}
  .card{background:#fff;padding:20px;border-radius:14px;box-shadow:0 12px 36px rgba(0,0,0,.06)}
  .content{display:flex;gap:20px;align-items:flex-start}
  .steps{flex:1}
  .step{display:flex;align-items:center;gap:14px;margin-bottom:18px}
  .circle{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
  .ok{background:#7fb36b;color:#fff}
  .off{border:3px solid #e6e6e6;color:#bbb;background:#fff}
  .step p{margin:0;font-size:1.05rem}
  .gerai-img{width:320px;max-width:100%;border-radius:10px;object-fit:cover}
  .btn{display:inline-block;margin-top:18px;padding:10px 18px;background:#f2994a;color:#fff;border-radius:8px;text-decoration:none}
  @media(max-width:720px){.content{flex-direction:column}.gerai-img{width:100%}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:36px;height:36px;border-radius:50%;background:#7fb36b"></div>
      <div style="font-weight:700">KantekGO!</div>
    </header>

    <h1 id="title">Pesanan kamu</h1>
    <p style="color:#666;margin-top:6px">Status pesanan kamu adalah sebagai berikut.</p>

    <div class="card" style="margin-top:18px">
      <div class="content">
        <div class="steps">
          <div class="step" id="step1">
            <div class="circle off">1</div>
            <p><strong>Menunggu antrian</strong></p>
          </div>
          <div class="step" id="step2">
            <div class="circle off">2</div>
            <p><strong>Sedang diproses</strong></p>
          </div>
          <div class="step" id="step3">
            <div class="circle off">3</div>
            <p><strong>Pesanan selesai</strong></p>
          </div>
          <div style="margin-top:10px"><strong>Estimasi waktu:</strong> <span id="eta">-</span> menit</div>
          <a class="btn" id="backBtn" href="index.html">Kembali ke Beranda</a>
        </div>

        <img id="geraiImg" class="gerai-img" src="" alt="Gambar Gerai" style="display:none">
      </div>
    </div>
  </div>

<script>
  function notify(title, body){
    if(window.Notification && Notification.permission === "granted"){
      new Notification(title, {body});
    } else if(window.Notification && Notification.permission !== "denied"){
      Notification.requestPermission().then(p=>{
        if(p==='granted') new Notification(title,{body});
        else alert(title + "\\n" + body);
      });
    } else alert(title + "\\n" + body);
  }

  const params = new URLSearchParams(location.search);
  const orderId = params.get('order');
  const geraiParam = params.get('gerai') || null;

  const id = geraiParam || '1';
  const img = document.getElementById('geraiImg');
  const statusFile = `gerai${id}_status.jpg`;
  const foodFile = `gerai${id}_food.jpg`;
  img.src = statusFile;
  img.alt = `Gerai ${id}`;
  img.style.display = 'block';
  img.onerror = () => { img.onerror = null; img.src = foodFile; };

  const h1 = document.getElementById('title');

  function refresh(){
    const orders = JSON.parse(localStorage.getItem('kantek_orders')||'[]');
    let order = null;
    if(orderId) order = orders.find(o=>o.id === orderId);
    else if(geraiParam){
      h1.textContent = 'Status Gerai ' + geraiParam;
      document.getElementById('eta').textContent = '-';
      return;
    }

    if(!order){ h1.textContent = 'Pesanan tidak ditemukan'; return; }
    h1.textContent = `Pesanan ${order.id} — Gerai ${order.gerai}`;
    document.getElementById('eta').textContent = order.etaMinutes || '-';

    const map = { 'menunggu antrian':1, 'sedang diproses':2, 'selesai':3 };
    const step = map[order.status] || 1;
    ['step1','step2','step3'].forEach((id,i)=>{
      const el = document.getElementById(id).querySelector('.circle');
      if(i < step) { el.className = 'circle ok'; el.textContent = '✓'; }
      else { el.className = 'circle off'; el.textContent = i+1; }
    });

    if(order.status === 'selesai'){
      notify('Pesanan selesai','Pesanan ' + order.id + ' telah selesai. Silakan ambil.');
    }

    try{
      const key = 'kantek_last_notif_' + order.buyer.id;
      const n = localStorage.getItem(key);
      if(n){
        const parsed = JSON.parse(n);
        notify('Notifikasi dari Gerai', parsed.message);
        localStorage.removeItem(key);
      }
    }catch(e){}
  }

  refresh();
  setInterval(refresh, 3000);
</script>
</body>
</html>
